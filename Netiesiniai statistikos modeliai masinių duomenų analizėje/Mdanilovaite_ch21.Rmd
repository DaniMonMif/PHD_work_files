---
title: "Mdanilovaite_ch21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## 21.7 7 Exercise

Consider the glass fragments data from the bookâ€™s website. Let *Y* be refractive index and let *X* be aluminum content (the fourth variable).

a. Do a nonparametric regression to fit the model *Y = f(x) +* \epsilon using the cosine basis method. The data are not on a regular grid. Ignore this when estimating the function. (But do sort the data first according to *x*). Provide a function estimate, an estimate of the risk, and a confidence band.

b. Use the wavelet method to estimate *f*.

```{r 21_7_7, echo=FALSE}
# ini libraries:
library('stats')

# read dataset and select columns:
df <- read.table( "https://www.stat.cmu.edu/~larry/all-of-statistics/=data/glass.dat", header = TRUE, fill = TRUE)

df = subset(df, select = -c(Na,Mg,Si,K,Ca,Ba,Fe,type) )
df <- df[order(df[,2]),] # order by x

x_sample = df[1:(2^trunc(log(length(df[,2]),2))),2]
step = ((max(df[,2]) - min(df[,2])) / 255)
t = seq(min(df[,2]), max(df[,2]), by=step)

# a ============================================================================
# Cosine basis function
phi_j <- function(j, x) 
  {
    if (j == 1)
      {
        result <- rep(1, length(x))
      }
    else 
      {
        result <- sqrt(2) * cos((j - 1) * pi * x)
      }
  }

n = nrow(df)
alpha = 0.05 # significance level

# normalize
X_scaled <- (df[,2] - min(df[,2])) / (max(df[,2]) - min(df[,2]))

beta_hat = rep(0, n)
for (j in 1:(n+1))
  {
    beta_hat[j - 1] <- sum(t(df[,1]) * phi_j(j, X_scaled)) / n
  } 

k = round(ceiling(n / 4), digits = 0)
range <- seq(from = length(beta_hat) - k , to = length(beta_hat), by = 1)
sigma2_hat = sum(beta_hat[range]**2) * (n / k)

risk_hat = rep(1, n)

for (J in 2:(n+1))
  {
      range <- seq(J-1, to = n, by = 1)
      risk_hat[J - 1] = J * sigma2_hat/n + sum(pmax(beta_hat[range]**2 - sigma2_hat/n, 0))
  }

J_hat = which.min(risk_hat) + 2

tau_hat = sigma2_hat * sqrt((2 * J_hat / n) * (1 + J_hat / k))
z_alpha = qnorm(1 - alpha / 2)
c = sqrt(2 * J * ((z_alpha * tau_hat / sqrt(n)) + (J_hat * sigma2_hat / n)))

# normalize
xx = (t - min(df[,2])) / (max(df[,2]) - min(df[,2]))
r_hat = rep(0, length(xx))
r_lower = rep(0, length(xx))
r_upper = rep(0, length(xx))

# risk estimation
for (j in 2:(J_hat+1))
{ 
  tmp = beta_hat[j - 1] * phi_j(j,xx)
    for (i in 1:length(xx))
    {
      r_hat[i] = r_hat[i] + tmp[i]
    }
}
  
# lower bound
for (i in 1:length(r_hat))
{
  r_lower[i] <- r_hat[i] - c
}

# upper bound
for (i in 1:length(r_hat))
{
  r_upper[i] <- r_hat[i] + c
}

# display plots
plot(df[,2],df[,1], xlim=c(0,max(t)), ylim=c(min(r_lower)-2,max(r_upper)+2), main="Nonparametric regression fit", xlab = "RI", ylab = "AL")
lines(sort(t),r_hat,col="red")
lines(sort(t),r_upper,col="blue")
lines(sort(t),r_lower,col="green")

# risk
print(risk_hat)
# regression f-tion
print(r_hat)

# confidence band
print(c)

# r f-tion bounds
print(r_upper)
print(r_lower)

legend(x = 2.8, y = 15, # Coordinates
       legend = c("r_hat", "CI upper bound", "CI lower bound", "Data point"),
 col=c("red", "blue", "green", "black"), lty=1, cex=0.6)

# b ============================================================================
# ini libraries
library("wavethresh")
library("waveslim")

# select number of points (multiple of 2):
df_s <- df[sample(nrow(df), 128), ]
df_s <- df_s[order(df_s[,2]),]

x <- df_s[, 2]
y1 <- df_s[, 1]

y1wd <- wd(y1, filter.number = 1, family="DaubExPhase") # select HAAR wavelets
y1ws <- wr(threshold(y1wd, policy = "manual", type = "hard", levels = 0:6, value = 2.75))

plot(df[,2],df[,1], xlim=c(0,max(t)), ylim=c(min(r_lower)-2,max(r_upper)+2), main="Haar wavelet fit",xlab = "RI", ylab = "AL")
lines(x, y1ws, col='red')
legend(x = 2.8, y = 15, # Coordinates
       legend = c("r_hat", "Data point"),
 col=c("red", "black"), lty=1, cex=0.6)
legend(2.5, -15, "Threshold = 2.75, levels = 0:6", cex = 0.6)

```
## 21.7 7 Analysis
a. Cosine basis function was defined (see 21.7 formula). Significance level was set to alpha = 0.05. Using theorem 21.8 (formula 21.24), Beta_hat was calculated. Using Orthogonal series risk estimate R_hat(J),  r_hat(x) was calculated as a nonparametric regression model:
r_hat(x) = 
  [1] -1.23182249 -1.22230440 -1.19382302 -1.14659628 -1.08098526 -0.99749097 -0.89674992 -0.77952839 -0.64671577 -0.49931661 -0.33844180 -0.16529885  0.01881871  0.21254252  0.41444132  0.62303316
 [17]  0.83679818  1.05419139  1.27365576  1.49363512  1.71258700  1.92899522  2.14138197  2.34831953  2.54844128  2.74045206  2.92313767  3.09537353  3.25613238  3.40449090  3.53963538  3.66086613
 [33]  3.76760086  3.85937689  3.93585216  3.99680513  4.04213357  4.07185221  4.08608940  4.08508271  4.06917369  4.03880167  3.99449687  3.93687281  3.86661804  3.78448754  3.69129356  3.58789629
 [49]  3.47519429  3.35411490  3.22560459  3.09061956  2.95011651  2.80504371  2.65633255  2.50488958  2.35158908  2.19726632  2.04271152  1.88866450  1.73581023  1.58477506  1.43612394  1.29035833
 [65]  1.14791508  1.00916610  0.87441878  0.74391729  0.61784456  0.49632496  0.37942758  0.26717021  0.15952362  0.05641647 -0.04225953 -0.13664423 -0.22690331 -0.31322259 -0.39580224 -0.47485107
 [81] -0.55058091 -0.62320131 -0.69291438 -0.75991009 -0.82436196 -0.88642314 -0.94622313 -1.00386493 -1.05942284 -1.11294090 -1.16443183 -1.21387673 -1.26122530 -1.30639676 -1.34928129 -1.38974208
 [97] -1.42761788 -1.46272604 -1.49486603 -1.52382325 -1.54937327 -1.57128625 -1.58933158 -1.60328263 -1.61292158 -1.61804418 -1.61846446 -1.61401925 -1.60457249 -1.59001924 -1.57028932 -1.54535053
[113] -1.51521150 -1.47992388 -1.43958414 -1.39433471 -1.34436454 -1.28990909 -1.23124963 -1.16871202 -1.10266483 -1.03351684 -0.96171407 -0.88773623 -0.81209264 -0.73531781 -0.65796650 -0.58060858
[129] -0.50382355 -0.42819479 -0.35430382 -0.28272438 -0.21401653 -0.14872087 -0.08735283 -0.03039729  0.02169664  0.06852043  0.10971052  0.14495231  0.17398356  0.19659733  0.21264421  0.22203410
[145]  0.22473714  0.22078417  0.21026645  0.19333466  0.17019738  0.14111884  0.10641610  0.06645562  0.02164935 -0.02754970 -0.08065236 -0.13713853 -0.19646275 -0.25806004 -0.32135191 -0.38575249
[161] -0.45067474 -0.51553653 -0.57976680 -0.64281136 -0.70413861 -0.76324485 -0.81965930 -0.87294871 -0.92272142 -0.96863099 -1.01037924 -1.04771876 -1.08045469 -1.10844602 -1.13160616 -1.14990291
[177] -1.16335778 -1.17204468 -1.17608809 -1.17566053 -1.17097961 -1.16230453 -1.14993215 -1.13419262 -1.11544476 -1.09407107 -1.07047258 -1.04506350 -1.01826585 -0.99050405 -0.96219947 -0.93376526
[193] -0.90560126 -0.87808911 -0.85158779 -0.82642941 -0.80291541 -0.78131328 -0.76185366 -0.74472805 -0.73008700 -0.71803888 -0.70864921 -0.70194056 -0.69789303 -0.69644527 -0.69749605 -0.70090632
[209] -0.70650178 -0.71407587 -0.72339319 -0.73419321 -0.74619439 -0.75909839 -0.77259466 -0.78636494 -0.80008805 -0.81344449 -0.82612110 -0.83781555 -0.84824068 -0.85712859 -0.86423441 -0.86933981
[225] -0.87225606 -0.87282674 -0.87092987 -0.86647975 -0.85942810 -0.84976483 -0.83751825 -0.82275466 -0.80557762 -0.78612647 -0.76457463 -0.74112718 -0.71601824 -0.68950779 -0.66187826 -0.63343075
[241] -0.60448101 -0.57535527 -0.54638590 -0.51790694 -0.49024972 -0.46373842 -0.43868573 -0.41538876 -0.39412506 -0.37514889 -0.35868793 -0.34494015 -0.33407129 -0.32621256 -0.32145897 -0.31986802

while R_hat(J):
[1]  6.762385  6.105387  5.906735  5.957183  5.980612  5.407253  5.111314  5.156904  5.207352  5.235811  5.286259  5.336708  5.387156  5.437604  5.488052  5.538501  5.499050  5.549498  5.598552
 [20]  5.649000  5.699448  5.644179  5.664629  5.715077  5.765525  5.815974  5.793835  5.844284  5.894732  5.839115  5.889563  5.940012  5.990460  6.040908  6.091356  6.141804  6.122012  6.172460
 [39]  6.222908  6.273356  6.323805  6.374253  6.424701  6.475149  6.486621  6.537069  6.587518  6.637966  6.688414  6.738862  6.789311  6.839759  6.890207  6.804699  6.855147  6.905596  6.956044
 [58]  7.006492  7.026078  6.973265  7.023713  7.074161  7.124609  7.175058  7.111653  6.998611  7.049059  7.099507  7.149955  7.200404  7.250852  7.296487  7.346935  7.397383  7.287123  7.337571
 [77]  7.351319  7.308004  7.358452  7.408901  7.459349  7.509797  7.560245  7.610693  7.661142  7.696522  7.746970  7.781089  7.831537  7.831255  7.877293  7.927742  7.977413  8.027862  8.078310
 [96]  8.106964  8.153240  8.203688  8.136437  8.186885  8.237334  8.287782  8.338230  8.388678  8.439126  8.489575  8.540023  8.553170  8.603618  8.587418  8.637866  8.688314  8.688899  8.725887
[115]  8.725329  8.775777  8.826226  8.858621  8.909069  8.959517  8.956602  9.000181  9.050629  9.073815  9.124263  9.174711  9.225159  9.275607  9.238332  8.995778  9.014573  9.065021  9.115469
[134]  9.165917  9.216366  9.266814  9.317262  9.179428  9.137024  9.187472  9.069218  9.119666  9.170114  9.220563  9.271011  9.295029  9.345478  9.268496  9.261942  9.312390  9.362839  9.413287
[153]  9.454661  9.447495  9.497943  9.548391  9.485085  9.535533  9.585981  9.489696  9.382192  9.386043  9.436491  9.486939  9.537388  9.547507  9.597955  9.590953  9.641401  9.691850  9.687959
[172]  9.731468  9.781916  9.832365  9.882813  9.933261  9.977839 10.028287 10.078735 10.129183 10.179632  9.957122  9.943544  9.993992 10.044440 10.094888 10.145336 10.195785 10.246233 10.296681
[191] 10.347129 10.397577 10.403083 10.453531 10.331310 10.374287 10.424735 10.440749 10.348865 10.375416 10.425864 10.476313 10.526761 10.577209 10.627657 10.678105 10.728554 10.779002 10.829450
[210] 10.692284 10.695019 10.745467 10.795915 10.846363

To calculate confidence band, 21.11 theorem was used to calculate c
c = 19.75023

Calculated regression, data and confidence intervals' upper and lower bounds were plotted.

b. To estimate *f* with HAAR wavelets, packet library("wavethresh") was used. Function wd was configured to perform DWT transform on data to produce HAAR wavelets (filter.number = 1, filter family = "DaubExPhase"). 

Use the wavelet method to estimate *f*.
